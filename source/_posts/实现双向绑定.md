---
title: 实现双向绑定
date: 2018-11-06 17:57:46
tags: JS
---

### 1. MVVM
MVVM(Model-View-ViewModel)结构模式，目的在于更清楚地将**用户界面(UI)的开发**与**应用程序中业务逻辑和行为的开发**区分开来。
Model, View, ViewModel之间的关系
> Models hold information, but typically don't handle behaviour. They don't format information or influence how data appears in the broswer as this isn't their responsibility. Instead, formatting of data is handled by the View, whilst behaviour is considered business logic that should be encapsulated in another layer that interacts with the Model - the ViewModel.

Model
是对现实世界中事物的抽象结果，就是建模。Model称为数据层。
> As with other members of the MV* family, the Model in MVVM represents domain-specific data or information that our application will be working with. A typical example of domain-specific data might be a user account (e.g name, avatar, e-mail) or a music track (e.g title, year, album).

View
用户操作界面， ViewModel对Model进行更新的时候，会通过数据绑定更新到View
> MVVM’s active View contains the data-bindings, events and behaviours which require an understanding of the Model and ViewModel. The View is responsible for handling events to the ViewModel. It’s important to remember the View isn’t responsible here for handling state - it keeps this in sync with the ViewModel.

ViewModel
对于 View 来说，你如果抽象得好，那么一个 App 的动画效果可以很方便地移植到别的 App 上，而 Github 上也有很多 UI 控件，这些控件都是在 View 层做了很好的封装设计，使得它能够方便地开源给大家复用。

对于 Model 来说，它其实是用来存储业务的数据的，如果做得好，它也可以方便地复用。

ViewModel有多少可以复用，结论是：非常难复用。
ViewModel应该做什么？那就是写那些不能复用的业务代码。
- 在初始化时，构造相应的View和Model
- 监听Model层的事件， 将Model层的数据传递到View层
- 监听View层的事件，并且将View层的事件转发到Model层

- 双向绑定
View需要什么数据，ViewModel要提供这个数据；
View有哪些操作，ViewModel就要响应这些操作
> The ViewModel can be considered a specialized Controller that acts as a data converter. It changes Model information into View information, passing commands from the View to the Model.The ViewModel sits behind our UI layer. It exposes data needed by a View (from a Model) and can be viewed as the source our Views go to for both data and actions.


数据驱动
所谓数据驱动，是指视图是由数据驱动生成的，我们对视图的修改，不会直接操作 DOM，而是通过修改数据。它相比我们传统的前端开发，如使用 jQuery 等前端库直接修改 DOM，大大简化了代码量。特别是当交互复杂的时候，只关心数据的修改会让代码的逻辑变的非常清晰，因为 DOM 变成了数据的映射，我们所有的逻辑都是对数据的修改，而不用碰触 DOM，这样的代码非常利于维护。

### 2. 数据劫持 Object.definedProperty
Vue采用数据劫持&发布-订阅模式的方式，通过Object.defineProperty()方法来劫持各属性的getter, setter，并在数据发生变动时通知ViewModel重新编译模板。



getter 收集依赖
这时候会做一些逻辑判断（保证同一数据不会被添加多次）后执行 dep.addSub(this)，那么就会执行 this.subs.push(sub)，也就是说把当前的 watcher 订阅到这个数据持有的 dep 的 subs 中，这个目的是为后续数据变化时候能通知到哪些 subs 做准备。

清空依赖
考虑到 Vue 是数据驱动的，所以每次数据变化都会重新 render，那么 vm._render() 方法又会再次执行，并再次触发数据的 getters

考虑到一种场景，我们的模板会根据 v-if 去渲染不同子模板 a 和 b，当我们满足某种条件的时候渲染 a 的时候，会访问到 a 中的数据，这时候我们对 a 使用的数据添加了 getter，做了依赖收集，那么当我们去修改 a 的数据的时候，理应通知到这些订阅者。那么如果我们一旦改变了条件渲染了 b 模板，又会对 b 使用的数据添加了 getter，如果我们没有依赖移除的过程，那么这时候我去修改 a 模板的数据，会通知 a 数据的订阅的回调，这显然是有浪费的。

因此 Vue 设计了在每次添加完新的订阅，会移除掉旧的订阅，这样就保证了在我们刚才的场景中，如果渲染 b 模板的时候去修改 a 模板的数据，a 数据订阅回调已经被移除了，所以不会有任何浪费，真的是非常赞叹 Vue 对一些细节上的处理。

#




### 参考资料
- [简单理解MVVM--实现Vue的MVVM模式](https://zhuanlan.zhihu.com/p/38296857)
- [被误解的 MVC](https://blog.devtang.com/2015/11/02/mvc-and-mvvm/)

- [Vue.js中的MVVM](https://juejin.im/post/5b2f0769e51d45589f46949e)
- [Vue.js的响应式系统原理](https://juejin.im/post/5b82b174518825431079d473)

- [Vue技术揭秘](https://ustbhuangyi.github.io/vue-analysis/data-driven/)


